name: Build release

on:
  schedule:
    - cron: '0 */1 * * *'
  push:


jobs:
  check:
    runs-on: ubuntu-latest
    outputs:
      release_needed: ${{ steps.check.outputs.release_needed }}
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Check if release needed
        id: check
        run: |
          RELEASE_NEEDED=$(python amm_update.py return_false)
          echo "::set-output name=release_needed::${RELEASE_NEEDED}"

  build:
    runs-on: ubuntu-latest
    needs: check
    if: needs.check.outputs.release_needed == 'true'
    steps:

      - name: check output
        run: |
          echo "output from previous job: ${{ needs.check.outputs.release_needed }}"
      - name: Checkout
        uses: actions/checkout@v2

      - name: Check if release needed
        run: |
          RELEASE_NEEDED=$(python amm_update.py check_release_needed)
          echo "::set-output name=release_needed::${RELEASE_NEEDED}"

      - name: Set outputs
        id: vars
        run: |
          GIT_REV=$(git rev-parse --short HEAD)
          echo "::set-output name=sha_short::${GIT_REV}"
          TIME=$(date +"%Y-%m-%d-%H_%M_%S")
          echo "::set-output name=release_time::${TIME}"
          echo "::set-output name=tag_name::version_${TIME}"

      - name: Check outputs
        run: |
          echo ${{ steps.vars.outputs.sha_short }}
          echo ${{ steps.vars.outputs.release_time }}
          echo ${{ steps.vars.outputs.tag_name }}

      # - name: Build app
      #   run: |
      #     FILE=runme-${{ steps.vars.outputs.sha_short }}.sh
      #     echo "#!/bin/bash" >> $FILE
      #     echo "echo \"It's ${{ steps.vars.outputs.release_time }}\"" >> $FILE

      - name: Build
        id: build
        run: |
          # git clone --depth 1 --branch "amm-core-functionality" "https://github.com/gregtatcam/rippled.git"
          git clone --depth 1 --branch "master" "https://github.com/legleux/source.git" rippled
          cd rippled
          echo "Im in $PWD"
          echo $(git rev-parse)
          git log
          GIT_REV=$(git rev-parse --short HEAD)
          echo "::set-output name=sha_short::${GIT_REV}"
          TIME=$(date +"%Y-%m-%d-%H_%M_%S")
          echo "::set-output name=release_time::${TIME}"
          echo "::set-output name=tag_name::version_${TIME}-${GIT_REV}"

          echo ${{ steps.vars.outputs.sha_short }}
          echo ${{ steps.vars.outputs.release_time }}
          echo ${{ steps.vars.outputs.tag_name }}

          docker run -v $PWD:/rippled legleux/amm-builder
          find . -name "rippled"

      - uses: avakar/tag-and-release@v1
        with:
          tag_name: ${{ steps.build.outputs.tag_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          name: "Version ${{ steps.build.outputs.sha_short }}"
          tag_name: ${{ steps.build.outputs.tag_name }}
          files: rippled/build-docker/rippled
